
<!DOCTYPE html>
<html lang="pt-br">
<head>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
  import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCIJUaoLxzeuNlQYqsNFa-YBHHfN0vcc6g",
    authDomain: "programacao-fribon-6de02.firebaseapp.com",
    databaseURL: "https://programacao-fribon-6de02-default-rtdb.firebaseio.com",
    projectId: "programacao-fribon-6de02",
    storageBucket: "programacao-fribon-6de02.firebasestorage.app",
    messagingSenderId: "590383729232",
    appId: "1:590383729232:web:49613653335c46b466df55"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  function salvarDados() {
    const blocos = document.querySelectorAll(".bloco-dia");
    const dados = {};

    blocos.forEach(bloco => {
      const data = bloco.getAttribute("data-dia");
      dados[data] = [];

      const linhas = bloco.querySelectorAll("tbody tr");
      linhas.forEach(linha => {
        const inputs = linha.querySelectorAll("input, select");
        const values = Array.from(inputs).map(i => i.value);
        dados[data].push(values);
      });
    });

    set(ref(db, "foletinho"), dados);
  }

  function carregarDados() {
    get(child(ref(db), "foletinho")).then(snapshot => {
      if (!snapshot.exists()) return;
      const dados = snapshot.val();

      const blocos = document.querySelectorAll(".bloco-dia");

      blocos.forEach(bloco => {
        const data = bloco.getAttribute("data-dia");
        const linhas = dados[data];
        if (!linhas) return;

        const rows = bloco.querySelectorAll("tbody tr");
        linhas.forEach((valores, i) => {
          const campos = rows[i]?.querySelectorAll("input, select") || [];
          valores.forEach((valor, j) => {
            if (campos[j]) {
              campos[j].value = valor;
              if (campos[j].tagName === "SELECT") atualizarCor(campos[j]);
            }
          });
        });
      });
    });
  }

  function atualizarCor(select) {
    const row = select.closest("tr");
    const cores = {
      "Programado": "#e0e0e0",
      "Agendado": "#d1ffd1",
      "Pendente Comprovante": "#fff5cc",
      "Anexado": "#cce5ff",
      "Aguardando Cota": "#ffd1d1"
    };
    row.style.backgroundColor = cores[select.value] || "";
  }

  window.addEventListener("DOMContentLoaded", () => {
    carregarDados();

    document.body.addEventListener("change", e => {
      if (e.target.matches("input, select")) {
        if (e.target.tagName === "SELECT") atualizarCor(e.target);
        salvarDados();
      }
    });

    document.body.addEventListener("input", e => {
      if (e.target.matches("input")) {
        salvarDados();
      }
    });
  });
</script>

  <meta charset="UTF-8" />
  <title>Programação Fribon Rota MT</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f9; padding: 20px; display: flex; justify-content: center; }
    .container { max-width: 1000px; width: 100%; }
    h1 { text-align: center; margin-bottom: 20px; }
    .search-bar { text-align: center; margin: 20px auto; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; table-layout: fixed; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #007bff; color: white; }
    input[type=text], select {
      padding: 6px;
      width: 95%;
      max-width: 160px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    .dia { margin-bottom: 40px; background: #fff; border-radius: 10px; padding: 20px; box-shadow: 0 0 10px #ccc; }
    .usina-box { margin-bottom: 10px; }
    .usina-box { display: flex; align-items: center; gap: 10px; flex-direction: row; } .usina-box input { width: 300px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Programação Fribon Rota MT</h1>
    <div class="search-bar">
      <input type="text" id="searchPlaca" onkeyup="filtrarPorPlaca()" placeholder="Buscar por placa...">
      <input type="text" id="searchData" placeholder="Buscar por data (DD/MM)" oninput="filtrarPorData()">
    </div>
    <datalist id="lista-usinas">
      <option value="FS LUCAS">
      <option value="FS SORRISO">
      <option value="INPASA MUTUM">
      <option value="INPASA SINOP">
      <option value="FRETE POR FORA">
    </datalist>
    <div id="dias-container"></div>
  </div>

  <script>
    const statusOptions = ["", "Programado", "Agendado", "Pendente Comprovante", "Anexado", "Aguardando Cota"];
    const colors = {
      "Programado": "#e0e0e0",
      "Agendado": "#d1ffd1",
      "Pendente Comprovante": "#fff5cc",
      "Anexado": "#cce5ff",
      "Aguardando Cota": "#ffd1d1"
    };

    function updateRowColor(select) {
      const row = select.closest('tr');
      const value = select.value;
      row.style.backgroundColor = colors[value] || "";
    }

    function gerarSemana() {
      const diasSemana = ["Domingo", "Segunda-feira", "Terça-feira", "Quarta-feira", "Quinta-feira", "Sexta-feira", "Sábado"];
      const container = document.getElementById("dias-container");
      container.innerHTML = "";
      const hoje = new Date();

      for (let d = 0; d < 7; d++) {
        const dataAtual = new Date();
        dataAtual.setDate(hoje.getDate() + d);
        const nomeDia = diasSemana[dataAtual.getDay()];
        const dataFormatada = dataAtual.toLocaleDateString("pt-BR");

        const bloco = document.createElement("div");
        bloco.className = "dia";
        bloco.innerHTML = `<h2>${nomeDia} - ${dataFormatada}</h2>`;

        for (let usina = 1; usina <= 2; usina++) {
          const usinaBox = document.createElement("div");
          usinaBox.className = "usina-box";
          usinaBox.innerHTML = `<label><strong>Usina ${usina}:</strong></label><br>
          <input type="text" list="lista-usinas" placeholder="Selecionar ou digitar usina">`;

          const tabela = document.createElement("table");
          tabela.innerHTML = `
            <thead><tr><th>Placa</th><th>Empresa</th><th>Status</th></tr></thead>
            <tbody>
              ${[...Array(10)].map(() => `
                <tr>
                  <td><input type="text" placeholder="ABC1D23"></td>
                  <td><input type="text" placeholder="Empresa"></td>
                  <td>
                    <select onchange="updateRowColor(this); saveData();">
                      ${statusOptions.map(s => `<option value="${s}">${s}</option>`).join("")}
                    </select>
                  </td>
                </tr>
              `).join("")}
            </tbody>
          `;
          bloco.appendChild(usinaBox);
          bloco.appendChild(tabela);
        }

        
        const usinaBox1 = bloco.querySelectorAll(".usina-box")[0];
        const usinaBox2 = bloco.querySelectorAll(".usina-box")[1];
        const tabelas = bloco.querySelectorAll("table");

        const contador1 = document.createElement("span");
        const contador2 = document.createElement("span");
        const totalFinal = document.createElement("div");

        contador1.style = "margin-left: 10px; font-weight: bold;";
        contador2.style = "margin-left: 10px; font-weight: bold;";
        totalFinal.style = "margin-top: 15px; text-align: right; font-weight: bold;";

        usinaBox1.querySelector("label").appendChild(contador1);
        usinaBox2.querySelector("label").appendChild(contador2);
        bloco.appendChild(totalFinal);

        const atualizarContador = () => {
          const placas1 = new Set();
          const placas2 = new Set();

          tabelas[0].querySelectorAll("tbody tr").forEach(row => {
            const placa = row.querySelector("td input").value.trim();
            if (placa) placas1.add(placa);
          });

          tabelas[1].querySelectorAll("tbody tr").forEach(row => {
            const placa = row.querySelector("td input").value.trim();
            if (placa) placas2.add(placa);
          });

          const qtd1 = placas1.size;
          const qtd2 = placas2.size;
          const total = qtd1 + qtd2;

          contador1.textContent = `(${qtd1} caminhões | ${qtd1 * 62} m³)`;
          contador2.textContent = `(${qtd2} caminhões | ${qtd2 * 62} m³)`;
          totalFinal.textContent = `Total do dia: ${total} caminhões | ${total * 62} m³`;
        };

        bloco.addEventListener("input", atualizarContador);
        atualizarContador();

        container.appendChild(bloco);
      }
    }

    function saveData() {
      const blocos = document.querySelectorAll(".dia");
      const dataSalvar = [];

      blocos.forEach(bloco => {
        const dataObj = {
          data: bloco.querySelector("h2").innerText,
          usinas: [],
          linhas: []
        };

        const usinasInputs = bloco.querySelectorAll(".usina-box input");
        usinasInputs.forEach(ui => dataObj.usinas.push(ui.value));

        const tabelas = bloco.querySelectorAll("table");
        tabelas.forEach(tb => {
          tb.querySelectorAll("tbody tr").forEach(tr => {
            const inputs = tr.querySelectorAll("input, select");
            dataObj.linhas.push(Array.from(inputs).map(el => el.value));
          });
        });

        dataSalvar.push(dataObj);
      });

      localStorage.setItem("programacao_fribon_dados", JSON.stringify(dataSalvar));
    }

    function loadData() {
      const saved = JSON.parse(localStorage.getItem("programacao_fribon_dados") || "[]");
      const blocos = document.querySelectorAll(".dia");

      saved.forEach((diaData, i) => {
        if (!blocos[i]) return;

        const usinas = blocos[i].querySelectorAll(".usina-box input");
        diaData.usinas.forEach((val, idx) => {
          if (usinas[idx]) usinas[idx].value = val;
        });

        const tabelas = blocos[i].querySelectorAll("table");
        let linhaIndex = 0;
        tabelas.forEach(tb => {
          tb.querySelectorAll("tbody tr").forEach(tr => {
            const inputs = tr.querySelectorAll("input, select");
            const valores = diaData.linhas[linhaIndex] || [];
            valores.forEach((val, j) => {
              if (inputs[j]) {
                inputs[j].value = val;
                if (inputs[j].tagName === "SELECT") {
                  updateRowColor(inputs[j]);
                }
              }
            });
            linhaIndex++;
          });
        });
      });
    }

    function filtrarPorPlaca() {
      const filtro = document.getElementById("searchPlaca").value.toUpperCase();
      const linhas = document.querySelectorAll("tbody tr");
      linhas.forEach(row => {
        const placa = row.querySelector("td input")?.value?.toUpperCase() || '';
        row.style.display = placa.includes(filtro) ? "" : "none";
      });
    }

    function filtrarPorData() {
      const filtro = document.getElementById("searchData").value;
      const blocos = document.querySelectorAll(".dia");
      blocos.forEach(bloco => {
        const titulo = bloco.querySelector("h2").innerText;
        const dataTexto = titulo.split(" - ")[1];
        const [dia, mes, ano] = dataTexto.split("/");
        const dataFormatada = `${dia.padStart(2, '0')}/${mes.padStart(2, '0')}`;
        bloco.style.display = (filtro === "" || filtro === dataFormatada) ? "" : "none";
      });
    }

    window.onload = () => {
      gerarSemana();
      setTimeout(loadData, 100);
    };
  </script>
</body>
</html>
