<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Programa√ß√£o Fribon Rota MT</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCIJUaoLxzeuNlQYqsNFa-YBHHfN0vcc6g",
      authDomain: "programacao-fribon-6de02.firebaseapp.com",
      databaseURL: "https://programacao-fribon-6de02-default-rtdb.firebaseio.com",
      projectId: "programacao-fribon-6de02",
      storageBucket: "programacao-fribon-6de02.firebasestorage.app",
      messagingSenderId: "590383729232",
      appId: "1:590383729232:web:49613653335c46b466df55"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const statusColors = {
      "Programado": "#e0e0e0",
      "Agendado": "#d1ffd1",
      "Pendente Comprovante": "#fff5cc",
      "Anexado": "#cce5ff",
      "Aguardando Cota": "#ffd1d1"
    };

    const statusOptions = ["", "Programado", "Agendado", "Pendente Comprovante", "Anexado", "Aguardando Cota"];

    function gerarSemana() {
      const container = document.getElementById("dias-container");
      const hoje = new Date();
      container.innerHTML = "";

      for (let d = 0; d < 7; d++) {
        const data = new Date();
        data.setDate(hoje.getDate() + d);
        const yyyyMMdd = data.toISOString().split("T")[0];
        const ddmm = `${String(data.getDate()).padStart(2, '0')}/${String(data.getMonth() + 1).padStart(2, '0')}`;

        const bloco = document.createElement("div");
        bloco.className = "dia";
        bloco.setAttribute("data-dia", yyyyMMdd);
        bloco.innerHTML = `
          <h2>${ddmm}</h2>
          <div class="usinas">
            <input class="usina" list="usina-options" placeholder="Usina 1">
            <span class="contagem"></span>
            <table><thead><tr><th>Placa</th><th>Empresa</th><th>Status</th></tr></thead><tbody>
              ${[...Array(5)].map(() => `
                <tr>
                  <td><input type="text" class="placa"></td>
                  <td><input type="text" class="empresa"></td>
                  <td>
                    <select class="status">
                      ${statusOptions.map(st => `<option value="${st}">${st}</option>`).join("")}
                    </select>
                  </td>
                </tr>`).join("")}
            </tbody></table>
            <input class="usina" list="usina-options" placeholder="Usina 2">
            <span class="contagem"></span>
            <table><thead><tr><th>Placa</th><th>Empresa</th><th>Status</th></tr></thead><tbody>
              ${[...Array(5)].map(() => `
                <tr>
                  <td><input type="text" class="placa"></td>
                  <td><input type="text" class="empresa"></td>
                  <td>
                    <select class="status">
                      ${statusOptions.map(st => `<option value="${st}">${st}</option>`).join("")}
                    </select>
                  </td>
                </tr>`).join("")}
            </tbody></table>
          </div>
        `;
        container.appendChild(bloco);
      }

      carregarFirebase();
    }

    function salvarFirebase() {
      const blocos = document.querySelectorAll(".dia");
      const dados = {};

      blocos.forEach(bloco => {
        const dia = bloco.getAttribute("data-dia");
        const usinas = bloco.querySelectorAll(".usina");
        const tabelas = bloco.querySelectorAll("table tbody");

        dados[dia] = {
          usinas: [usinas[0].value, usinas[1].value],
          linhas: []
        };

        tabelas.forEach(tabela => {
          const linhas = [];
          tabela.querySelectorAll("tr").forEach(tr => {
            const campos = tr.querySelectorAll("input, select");
            linhas.push(Array.from(campos).map(c => c.value));
          });
          dados[dia].linhas.push(...linhas);
        });
      });

      set(ref(db, "programacao-semanal"), dados);
    }

    function carregarFirebase() {
      get(child(ref(db), "programacao-semanal")).then(snapshot => {
        const dados = snapshot.val() || {};
        document.querySelectorAll(".dia").forEach(bloco => {
          const dia = bloco.getAttribute("data-dia");
          if (!dados[dia]) return;

          const usinas = bloco.querySelectorAll(".usina");
          usinas[0].value = dados[dia].usinas[0] || "";
          usinas[1].value = dados[dia].usinas[1] || "";

          const linhas = bloco.querySelectorAll("table tbody tr");
          dados[dia].linhas.forEach((linha, i) => {
            const campos = linhas[i]?.querySelectorAll("input, select") || [];
            linha.forEach((valor, j) => {
              if (campos[j]) {
                campos[j].value = valor;
                if (campos[j].classList.contains("status")) atualizarCor(campos[j]);
              }
            });
          });

          atualizarContagem(bloco);
        });
      });
    }

    function atualizarCor(select) {
      const tr = select.closest("tr");
      tr.style.backgroundColor = statusColors[select.value] || "";
    }

    function atualizarContagem(bloco) {
      const tabelas = bloco.querySelectorAll("table tbody");
      tabelas.forEach((tbody, i) => {
        const linhas = tbody.querySelectorAll("tr");
        const placasPreenchidas = Array.from(linhas).filter(tr => tr.querySelector(".placa").value.trim()).length;
        const volume = placasPreenchidas * 62;
        bloco.querySelectorAll(".contagem")[i].textContent = `${placasPreenchidas} caminh√µes (${volume} m¬≥)`;
      });
    }

    window.addEventListener("DOMContentLoaded", () => {
      gerarSemana();

      document.body.addEventListener("input", e => {
        if (e.target.matches("input, select")) {
          if (e.target.classList.contains("status")) atualizarCor(e.target);
          const bloco = e.target.closest(".dia");
          if (bloco) atualizarContagem(bloco);
          salvarFirebase();
        }
      });
    });
  </script>

  <datalist id="usina-options">
    <option value="FS LUCAS"></option>
    <option value="FS SORRISO"></option>
    <option value="INPASA MUTUM"></option>
    <option value="INPASA SINOP"></option>
    <option value="FRETE POR FORA"></option>
  </datalist>

  
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f9f9f9;
    margin: 0;
    padding: 10px;
  }
  h1 {
    text-align: center;
    font-size: 20px;
    margin: 0;
    margin-bottom: 10px;
  }
  .busca {
    text-align: center;
    margin-bottom: 10px;
  }
  .busca input {
    padding: 6px;
    font-size: 12px;
    width: 160px;
    margin: 0 5px;
  }
  .dia {
    margin-bottom: 25px;
    background: #fff;
    border-radius: 6px;
    padding: 10px;
    box-shadow: 0 0 3px #bbb;
    font-size: 12px;
  }
  .dia h2 {
    margin: 0 0 8px;
    font-size: 14px;
    color: #333;
  }
  .usinas {
    display: flex;
    flex-direction: column;
    gap: 5px;
  }
  .usina {
    width: 200px;
    padding: 4px;
    font-size: 12px;
    margin-bottom: 2px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 4px;
  }
  th, td {
    border: 1px solid #ccc;
    padding: 4px;
    text-align: center;
    font-size: 12px;
  }
  th {
    background: #007bff;
    color: #fff;
  }
  select, input[type="text"] {
    width: 100%;
    font-size: 12px;
    padding: 2px;
  }
  .contagem {
    font-weight: bold;
    font-size: 12px;
    margin-left: 8px;
  }
</style>

</head>
<body>
  <h1>Programa√ß√£o Fribon Rota MT</h1>
  <div class="busca">
    <input type="text" id="busca-placa" placeholder="üîé Buscar por placa">
    <input type="date" id="busca-data">
  </div>
  <div id="dias-container"></div>
</body>
</html>
